{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="content-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-graduation-cap me-2"></i>{{ page_title }}</h2>
        <div>
            <span class="badge 
                {% if order.status == 'completed' %}bg-success
                {% elif order.status == 'in_progress' %}bg-primary
                {% elif order.status == 'paid' %}bg-info
                {% else %}bg-warning{% endif %}">
                {{ order.get_status_display }}
            </span>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Программа курса</h5>
                </div>
                <div class="card-body">
                    {% if modules %}
                    <div class="list-group mb-3">
                        {% for module in modules %}
                        <div class="list-group-item {% if module.id in completed_module_ids %}list-group-item-success{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        {% if module.id in completed_module_ids %}
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                        {% else %}
                                            <i class="far fa-circle me-2"></i>
                                        {% endif %}
                                        Модуль {{ forloop.counter }}: {{ module.title }}
                                    </h6>
                                    <p class="mb-1 small">{{ module.description }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ module.duration_hours }} часов
                                    </small>
                                </div>
                                {% if order.status == 'in_progress' or order.status == 'paid' %}
                                    {% if module.id not in completed_module_ids %}
                                    <button class="btn btn-sm btn-outline-primary mark-complete" 
                                            data-module="{{ module.id }}"
                                            data-module-title="{{ module.title }}">
                                        <i class="fas fa-check me-1"></i>Отметить пройденным
                                    </button>
                                    {% else %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Пройдено
                                    </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if order.status == 'in_progress' or order.status == 'paid' %}
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-tasks me-2"></i>Ваши действия:</h6>
                        <div class="mt-2">
                            <p>1. Изучите материалы модуля</p>
                            <p>2. Нажмите кнопку "Отметить пройденным" рядом с модулем</p>
                            <p>3. После прохождения всех модулей вы сможете завершить курс</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Программа курса пока не добавлена преподавателем.
                    </div>
                    {% endif %}
                    
                    {% if order.status == 'completed' %}
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-trophy me-2"></i>
                        <strong>Поздравляем!</strong> Вы успешно завершили этот курс.
                        {% if order.rating %}
                        <div class="mt-2">
                            <strong>Ваша оценка:</strong>
                            {% for i in "12345" %}
                                {% if forloop.counter <= order.rating %}
                                    <i class="fas fa-star text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if order.feedback %}
                        <div class="mt-2">
                            <strong>Ваш отзыв:</strong>
                            <p class="mb-0">{{ order.feedback }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Прогресс обучения</h5>
                </div>
                <div class="card-body text-center">
                    <div class="progress-circle mb-3" style="width: 150px; height: 150px; margin: 0 auto;">
                        <div class="position-relative" style="width: 150px; height: 150px;">
                            <svg width="150" height="150" viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#eee"
                                    stroke-width="3"/>
                                <path class="circle"
                                    stroke-dasharray="{{ order.progress|floatformat:0 }}, 100"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="{% if order.progress == 100 %}#28a745{% else %}#007bff{% endif %}"
                                    stroke-width="3"
                                    stroke-linecap="round"/>
                                <text x="18" y="20" class="percentage" text-anchor="middle" dy="0.3em" 
                                      style="font-size: 0.5em; font-weight: bold; fill: {% if order.progress == 100 %}#28a745{% else %}#007bff{% endif %};">
                                    {{ order.progress|floatformat:0 }}%
                                </text>
                            </svg>
                        </div>
                    </div>
                    
                    <h4>{{ order.progress|floatformat:0 }}% завершено</h4>
                    
                    <p class="text-muted small mb-4">
                        Пройдено модулей: {{ order.completed_modules_count }} из {{ order.total_modules_count }}
                    </p>
                    
                    {% if order.status == 'in_progress' or order.status == 'paid' %}
                    <div class="mt-4">
                        {% if order.completed_modules_count >= order.total_modules_count and order.total_modules_count > 0 %}
                        <div class="mb-3">
                            <a href="{% url 'courses:complete_course' order.id %}" class="btn btn-success w-100" id="completeCourseBtn">
                                <i class="fas fa-graduation-cap me-2"></i>Завершить курс
                            </a>
                            <p class="text-muted small mt-2 text-center">
                                <i class="fas fa-info-circle me-1"></i>
                                Пройдены все модули. Нажмите, чтобы завершить курс и оставить отзыв.
                            </p>
                        </div>
                        {% elif order.total_modules_count > 0 %}
                        <div class="mb-3">
                            <p class="text-warning small text-center">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                Пройдите все модули, чтобы завершить курс
                            </p>
                        </div>
                        {% elif order.total_modules_count == 0 %}
                        <div class="mb-3">
                            <p class="text-info small text-center">
                                <i class="fas fa-info-circle me-1"></i>
                                Преподаватель еще не добавил модули к курсу
                            </p>
                        </div>
                        {% endif %}
                        
                        <div class="mt-3">
                            <a href="{% url 'courses:cancel_course' order.id %}" class="btn btn-warning w-100">
                                <i class="fas fa-ban me-2"></i>Отменить курс
                            </a>
                        </div>
                    </div>
                    {% elif order.status == 'completed' or order.status == 'cancelled' %}
                    <div class="mt-3">
                        <a href="{% url 'courses:delete_course' order.id %}" class="btn btn-outline-danger w-100">
                            <i class="fas fa-trash-alt me-2"></i>Удалить запись
                        </a>
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <div class="text-start">
                        <p><strong><i class="fas fa-calendar-alt me-2"></i>Начало:</strong><br>
                        {{ order.start_date|date:"d.m.Y" }}</p>
                        
                        <p><strong><i class="fas fa-calendar-check me-2"></i>Окончание:</strong><br>
                        {{ order.expected_end_date|date:"d.m.Y" }}</p>
                        
                        <p><strong><i class="fas fa-clock me-2"></i>Осталось дней:</strong><br>
                        {{ order.days_remaining }}</p>
                        
                        <p><strong><i class="fas fa-money-bill-wave me-2"></i>Стоимость:</strong><br>
                        {{ order.price_paid }} руб.</p>

                        {% if order.notes %}
                        <p><strong><i class="fas fa-comment me-2"></i>Ваш комментарий при записи:</strong><br>
                        {{ order.notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Преподаватель</h5>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>{{ course.teacher.get_full_name|default:course.teacher.username }}</strong></p>
                    <p class="small text-muted mb-2">{{ course.teacher.specialization|default:"Преподаватель английского" }}</p>
                    <p class="small"><i class="fas fa-envelope me-1"></i>{{ course.teacher.email }}</p>
                    
                    {% if course.teacher.experience %}
                    <p class="small"><i class="fas fa-briefcase me-1"></i>Опыт работы: {{ course.teacher.experience }} лет</p>
                    {% endif %}
                    
                    {% if order.status == 'in_progress' or order.status == 'paid' %}
                    <div class="mt-3">
                        <a href="mailto:{{ course.teacher.email }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-envelope me-1"></i>Написать преподавателю
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if order.status == 'completed' %}
            <div class="card mt-3 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-certificate me-2"></i>Сертификат</h5>
                </div>
                <div class="card-body text-center">
                    <i class="fas fa-award fa-3x text-success mb-3"></i>
                    <p>Курс успешно завершен</p>
                    <p class="small text-muted">Дата завершения: {{ order.actual_end_date|date:"d.m.Y" }}</p>
                    <button class="btn btn-outline-success btn-sm" onclick="alert('Сертификат будет доступен для скачивания в ближайшее время')">
                        <i class="fas fa-download me-1"></i>Скачать сертификат
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 150);
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.mark-complete').forEach(button => {
        button.addEventListener('click', function() {
            const moduleId = this.dataset.module;
            const moduleTitle = this.dataset.moduleTitle;
            
            if (!moduleId || moduleId === '0') {
                showNotification('Ошибка: неверный ID модуля', 'danger');
                return;
            }
            
            if (confirm(`Вы уверены, что хотите отметить модуль "${moduleTitle}" как пройденный?`)) {
                markModuleComplete(moduleId, moduleTitle);
            }
        });
    });
});

function updateProgressVisual(value) {
    const percentage = document.querySelector('.percentage');
    const circle = document.querySelector('.circle');
    
    if (percentage) {
        percentage.textContent = Math.round(value) + '%';
    }
    if (circle) {
        circle.setAttribute('stroke-dasharray', Math.round(value) + ', 100');
        if (value == 100) {
            circle.setAttribute('stroke', '#28a745');
            percentage.style.fill = '#28a745';
        } else {
            circle.setAttribute('stroke', '#007bff');
            percentage.style.fill = '#007bff';
        }
    }
}

function updateCourseProgress(completedModules, totalModules) {
    const progress = Math.round((completedModules / totalModules) * 100);
    const progressHeader = document.querySelector('h4');
    
    updateProgressVisual(progress);
    
    if (progressHeader) {
        progressHeader.textContent = progress + '% завершено';
    }
    
    const progressText = document.querySelector('.text-muted.small.mb-4');
    if (progressText) {
        progressText.textContent = 'Пройдено модулей: ' + completedModules + ' из ' + totalModules;
    }
    
    return progress;
}

function markModuleComplete(moduleId, moduleTitle) {
    if (!moduleId || moduleId === '0') {
        showNotification('Ошибка: неверный ID модуля', 'danger');
        return;
    }
    
    const url = "{% url 'courses:mark_module_complete' order.id 999999 %}".replace('999999', moduleId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: ''
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const button = document.querySelector(`[data-module="${moduleId}"]`);
            if (button) {
                button.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Пройдено</span>';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success', 'disabled');
                button.disabled = true;
                
                const moduleItem = button.closest('.list-group-item');
                if (moduleItem) {
                    moduleItem.classList.add('list-group-item-success');
                    
                    const moduleIcon = moduleItem.querySelector('i');
                    if (moduleIcon) {
                        moduleIcon.classList.remove('far', 'fa-circle');
                        moduleIcon.classList.add('fas', 'fa-check-circle', 'text-success');
                    }
                }
            }
            
            const progress = updateCourseProgress(data.completed_modules, data.total_modules);
            
            const completeCourseBtn = document.getElementById('completeCourseBtn');
            const warningMessage = document.querySelector('.text-warning.small.text-center');
            
            if (data.completed_modules >= data.total_modules && data.total_modules > 0) {
                if (!completeCourseBtn) {
                    const newButton = document.createElement('a');
                    newButton.id = 'completeCourseBtn';
                    newButton.href = "{% url 'courses:complete_course' order.id %}";
                    newButton.className = 'btn btn-success w-100 mb-3';
                    newButton.innerHTML = '<i class="fas fa-graduation-cap me-2"></i>Завершить курс';
                    
                    const infoText = document.createElement('p');
                    infoText.className = 'text-muted small mt-2 text-center';
                    infoText.innerHTML = '<i class="fas fa-info-circle me-1"></i> Пройдены все модули. Нажмите, чтобы завершить курс и оставить отзыв.';
                    
                    const container = document.createElement('div');
                    container.className = 'mb-3';
                    container.appendChild(newButton);
                    container.appendChild(infoText);
                    
                    const cancelButton = document.querySelector('.btn-warning');
                    if (cancelButton && cancelButton.parentNode) {
                        cancelButton.parentNode.insertBefore(container, cancelButton);
                    }
                }
                
                if (warningMessage) {
                    warningMessage.style.display = 'none';
                }
                
                showNotification('Все модули пройдены! Теперь вы можете завершить курс.', 'success');
            } else {
                if (completeCourseBtn) {
                    completeCourseBtn.remove();
                    const infoText = completeCourseBtn.nextElementSibling;
                    if (infoText && infoText.classList.contains('text-muted')) {
                        infoText.remove();
                    }
                }
                
                if (warningMessage) {
                    warningMessage.style.display = 'block';
                }
                
                showNotification('Модуль "' + moduleTitle + '" отмечен как пройденный', 'success');
            }
            
            updateMyCoursesPage(progress, data.completed_modules, data.total_modules);
            
        } else {
            showNotification('Ошибка: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Произошла ошибка при сохранении модуля', 'danger');
    });
}

function updateMyCoursesPage(progress, completedModules, totalModules) {
    const courseRow = document.querySelector(`tr:has(a[href*="{% url 'courses:course_student_detail' order.id %}"])`);
    if (!courseRow) return;
    
    const progressBar = courseRow.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';
        if (progress == 100) {
            progressBar.classList.add('bg-success');
        }
    }
    
    const statusBadge = courseRow.querySelector('.badge');
    if (statusBadge && progress == 100) {
        const completeCourseBtn = document.getElementById('completeCourseBtn');
        if (!completeCourseBtn) {
            statusBadge.textContent = 'Завершено';
            statusBadge.className = 'badge bg-success';
            
            const actionTd = courseRow.querySelector('td:last-child');
            if (actionTd) {
                actionTd.innerHTML = `
                    <div class="d-flex flex-column gap-1">
                        <span class="text-success mb-1">
                            <i class="fas fa-check-circle me-1"></i>Завершен
                        </span>
                        <a href="{% url 'courses:delete_course' order.id %}" 
                           class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash-alt me-1"></i>Удалить
                        </a>
                    </div>
                `;
            }
        }
    }
}
</script>

<style>
.circular-chart {
    display: block;
    margin: 10px auto;
    max-width: 80%;
    max-height: 250px;
}

.circle {
    stroke: #007bff;
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
    animation: progress 1s ease-out forwards;
}

.circle-bg {
    fill: none;
    stroke: #eee;
    stroke-width: 3;
}

.percentage {
    fill: #666;
    font-family: sans-serif;
    font-size: 0.5em;
    text-anchor: middle;
}

@keyframes progress {
    0% {
        stroke-dasharray: 0 100;
    }
}

.progress-circle {
    position: relative;
}

.list-group-item-success {
    background-color: #d1e7dd;
    border-color: #badbcc;
}

.mark-complete:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}
</style>
{% endblock %}