{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="content-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-graduation-cap me-2"></i>{{ page_title }}</h2>
        <div>
            <span class="badge 
                {% if order.status == 'completed' %}bg-success
                {% elif order.status == 'in_progress' %}bg-primary
                {% elif order.status == 'paid' %}bg-info
                {% else %}bg-warning{% endif %}">
                {{ order.get_status_display }}
            </span>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Программа курса</h5>
                </div>
                <div class="card-body">
                    {% if modules %}
                    <div class="list-group mb-3">
                        {% for module in modules %}
                        <div class="list-group-item {% if module.id in completed_module_ids %}list-group-item-success{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        {% if module.id in completed_module_ids %}
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                        {% else %}
                                            <i class="far fa-circle me-2"></i>
                                        {% endif %}
                                        Модуль {{ forloop.counter }}: {{ module.title }}
                                    </h6>
                                    <p class="mb-1 small">{{ module.description }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ module.duration_hours }} часов
                                    </small>
                                </div>
                                {% if order.status == 'in_progress' and module.id not in completed_module_ids %}
                                <button class="btn btn-sm btn-outline-primary mark-complete" 
                                        data-module="{{ module.id }}"
                                        data-module-title="{{ module.title }}">
                                    <i class="fas fa-check me-1"></i>Отметить пройденным
                                </button>
                                {% elif module.id in completed_module_ids %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Пройдено
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">Программа курса пока не добавлена.</p>
                    {% endif %}
                    
                    {% if order.status == 'completed' %}
                    <div class="alert alert-success">
                        <i class="fas fa-trophy me-2"></i>
                        <strong>Поздравляем!</strong> Вы успешно завершили этот курс.
                        {% if order.rating %}
                        <div class="mt-2">
                            <strong>Ваша оценка:</strong>
                            {% for i in "12345" %}
                                {% if forloop.counter <= order.rating %}
                                    <i class="fas fa-star text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if order.feedback %}
                        <div class="mt-2">
                            <strong>Ваш отзыв:</strong>
                            <p class="mb-0">{{ order.feedback }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Прогресс обучения</h5>
                </div>
                <div class="card-body text-center">
                    <div class="progress-circle mb-3" style="width: 150px; height: 150px; margin: 0 auto;">
                        <div class="position-relative" style="width: 150px; height: 150px;">
                            <svg width="150" height="150" viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#eee"
                                    stroke-width="3"/>
                                <path class="circle"
                                    stroke-dasharray="{{ order.progress|floatformat:0 }}, 100"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="{% if order.progress == 100 %}#28a745{% else %}#007bff{% endif %}"
                                    stroke-width="3"
                                    stroke-linecap="round"/>
                                <text x="18" y="20" class="percentage" text-anchor="middle" dy="0.3em" 
                                      style="font-size: 0.5em; font-weight: bold; fill: {% if order.progress == 100 %}#28a745{% else %}#007bff{% endif %};">
                                    {{ order.progress|floatformat:0 }}%
                                </text>
                            </svg>
                        </div>
                    </div>
                    
                    <h4>{{ order.progress|floatformat:0 }}% завершено</h4>
                    
                    <p class="text-muted small mb-4">
                        Пройдено модулей: {{ order.completed_modules_count }} из {{ order.total_modules_count }}
                    </p>
                    
                    {% if order.status == 'in_progress' %}
                    <div class="mt-4">
                        <label for="progressSlider" class="form-label">Установите прогресс вручную:</label>
                        <input type="range" class="form-range" id="progressSlider" 
                               min="0" max="100" value="{{ order.progress|floatformat:0 }}"
                               oninput="updateProgressSlider(this.value)">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small>50%</small>
                            <small>100%</small>
                        </div>
                        <button class="btn btn-primary w-100 mt-3" onclick="saveProgress()">
                            <i class="fas fa-save me-2"></i>Сохранить прогресс
                        </button>
                        
                        {% if order.completed_modules_count >= order.total_modules_count and order.progress >= 100 %}
                        <div class="mt-3">
                            <a href="{% url 'courses:complete_course' order.id %}" class="btn btn-success w-100">
                                <i class="fas fa-graduation-cap me-2"></i>Завершить курс
                            </a>
                            <p class="text-muted small mt-2 text-center">
                                <i class="fas fa-info-circle me-1"></i>
                                Пройдены все модули. Нажмите, чтобы завершить курс и оставить отзыв.
                            </p>
                        </div>
                        {% endif %}
                        {% if order.status != 'completed' and order.status != 'cancelled' %}
                        <div class="mt-3">
                            <a href="{% url 'courses:cancel_course' order.id %}" class="btn btn-warning w-100">
                                <i class="fas fa-ban me-2"></i>Отменить курс
                            </a>
                        </div>
                        {% elif order.status == 'completed' or order.status == 'cancelled' %}
                        <div class="mt-3">
                            <a href="{% url 'courses:delete_course' order.id %}" class="btn btn-outline-danger w-100">
                                <i class="fas fa-trash-alt me-2"></i>Удалить запись
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <div class="text-start">
                        <p><strong><i class="fas fa-calendar-alt me-2"></i>Начало:</strong><br>
                        {{ order.start_date|date:"d.m.Y" }}</p>
                        
                        <p><strong><i class="fas fa-calendar-check me-2"></i>Окончание:</strong><br>
                        {{ order.expected_end_date|date:"d.m.Y" }}</p>
                        
                        <p><strong><i class="fas fa-clock me-2"></i>Осталось дней:</strong><br>
                        {{ order.days_remaining }}</p>
                        
                        <p><strong><i class="fas fa-money-bill-wave me-2"></i>Стоимость:</strong><br>
                        {{ order.price_paid }} руб.</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Преподаватель</h5>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>{{ course.teacher.get_full_name|default:course.teacher.username }}</strong></p>
                    <p class="small text-muted mb-2">{{ course.teacher.specialization|default:"Преподаватель английского" }}</p>
                    <p class="small"><i class="fas fa-envelope me-1"></i>{{ course.teacher.email }}</p>
                    
                    {% if course.teacher.experience %}
                    <p class="small"><i class="fas fa-briefcase me-1"></i>Опыт работы: {{ course.teacher.experience }} лет</p>
                    {% endif %}
                    
                    {% if order.status == 'in_progress' %}
                    <div class="mt-3">
                        <a href="mailto:{{ course.teacher.email }}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-envelope me-1"></i>Написать преподавателю
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if order.status == 'completed' %}
            <div class="card mt-3 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-certificate me-2"></i>Сертификат</h5>
                </div>
                <div class="card-body text-center">
                    <i class="fas fa-award fa-3x text-success mb-3"></i>
                    <p>Курс успешно завершен</p>
                    <p class="small text-muted">Дата завершения: {{ order.actual_end_date|date:"d.m.Y" }}</p>
                    <button class="btn btn-outline-success btn-sm" onclick="alert('Сертификат будет доступен для скачивания в ближайшее время')">
                        <i class="fas fa-download me-1"></i>Скачать сертификат
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function updateProgressSlider(value) {
    document.querySelector('.percentage').textContent = value + '%';
    document.querySelector('.circle').setAttribute('stroke-dasharray', value + ', 100');
}

function saveProgress() {
    const progress = document.getElementById('progressSlider').value;
    const url = "{% url 'courses:update_progress' order.id %}";
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'progress=' + progress
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Прогресс сохранен! Пройдено ' + data.completed_modules + ' из ' + data.total_modules + ' модулей.');
            
            document.querySelector('.percentage').textContent = data.progress + '%';
            document.querySelector('.circle').setAttribute('stroke-dasharray', data.progress + ', 100');
            document.getElementById('progressSlider').value = data.progress;
            
            const progressText = document.querySelector('.text-muted.small.mb-4');
            if (progressText) {
                progressText.textContent = 'Пройдено модулей: ' + data.completed_modules + ' из ' + data.total_modules;
            }
            
            if (data.progress >= 100 && data.completed_modules >= data.total_modules) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при сохранении');
    });
}

function markModuleComplete(moduleId, moduleTitle) {
    const url = "{% url 'courses:mark_module_complete' order.id 0 %}".replace('0', moduleId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: ''
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const roundedProgress = Math.round(data.progress);
            document.querySelector('.percentage').textContent = roundedProgress + '%';
            document.querySelector('.circle').setAttribute('stroke-dasharray', roundedProgress + ', 100');
            document.getElementById('progressSlider').value = roundedProgress;
            
            const button = document.querySelector(`[data-module="${moduleId}"]`);
            if (button) {
                button.innerHTML = '<i class="fas fa-check me-1"></i>Пройдено';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');
                button.disabled = true;
                
                const moduleIcon = button.closest('.list-group-item').querySelector('i');
                if (moduleIcon) {
                    moduleIcon.classList.remove('far', 'fa-circle');
                    moduleIcon.classList.add('fas', 'fa-check-circle', 'text-success');
                }
                
                button.closest('.list-group-item').classList.add('list-group-item-success');
            }
            
            const progressText = document.querySelector('.text-muted.small.mb-4');
            if (progressText) {
                progressText.textContent = 'Пройдено модулей: ' + data.completed_modules + ' из ' + data.total_modules;
            }
            
            alert(data.message);
            
            if (data.progress >= 100 && data.completed_modules >= data.total_modules) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при сохранении');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.mark-complete').forEach(button => {
        button.addEventListener('click', function() {
            const moduleId = this.dataset.module;
            const moduleTitle = this.dataset.moduleTitle;
            markModuleComplete(moduleId, moduleTitle);
        });
    });
});
</script>

<style>
.circular-chart {
    display: block;
    margin: 10px auto;
    max-width: 80%;
    max-height: 250px;
}

.circle {
    stroke: #007bff;
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
    animation: progress 1s ease-out forwards;
}

.circle-bg {
    fill: none;
    stroke: #eee;
    stroke-width: 3;
}

.percentage {
    fill: #666;
    font-family: sans-serif;
    font-size: 0.5em;
    text-anchor: middle;
}

@keyframes progress {
    0% {
        stroke-dasharray: 0 100;
    }
}

.progress-circle {
    position: relative;
}

.list-group-item-success {
    background-color: #d1e7dd;
    border-color: #badbcc;
}

.mark-complete:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}
</style>
{% endblock %}