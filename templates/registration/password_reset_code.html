{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
<div class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="col-md-8 col-lg-6">
        <div class="content-card text-center">
            <div class="success-icon mb-4">
                <i class="fas fa-envelope-circle-check fa-4x text-primary"></i>
            </div>
            
            <h2 class="mb-4">{{ page_title }}</h2>
            
            <p class="lead mb-1">
                Мы отправили 6-значный код подтверждения на:
            </p>
            <p class="lead mb-4">
                <strong>{{ email }}</strong>
            </p>
            
            <p class="text-muted mb-4">
                Введите код из письма ниже. Код действителен 30 минут.
            </p>
            
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <form method="post" novalidate id="codeForm">
                {% csrf_token %}
                
                <input type="hidden" name="email" value="{{ email }}">
                <input type="hidden" name="code" id="code" value="">
                
                <div class="mb-4">
                    <label for="code" class="form-label mb-3">
                        6-значный код
                    </label>
                    <div class="d-flex justify-content-center gap-2 mb-3" id="codeInputs">
                        {% for i in "123456"|make_list %}
                        <input type="text" 
                               maxlength="1" 
                               class="form-control code-digit text-center" 
                               style="width: 50px; height: 60px; font-size: 24px;"
                               data-index="{{ forloop.counter0 }}"
                               autocomplete="off">
                        {% endfor %}
                    </div>
                    {% if form.code.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.code.errors.0 }}
                    </div>
                    {% endif %}
                </div>
            </form>
            
            <div class="d-grid gap-2 mb-4">
                <button type="button" 
                        id="resendBtn" 
                        class="btn btn-outline-secondary py-3"
                        {% if not can_resend %}disabled{% endif %}>
                    <i class="fas fa-redo me-2"></i>
                    <span id="resendText">
                        {% if can_resend %}
                            Отправить код повторно
                        {% else %}
                            Повторная отправка через <span id="countdown">{{ time_left }}</span> сек
                        {% endif %}
                    </span>
                </button>
            </div>
            
            <div class="mt-4 pt-3 border-top">
                <p class="mb-2 small">
                    Не получили письмо? Проверьте папку "Спам".
                </p>
                <p class="mb-0">
                    <a href="{% url 'users:password_reset' %}" class="text-decoration-none">
                        <i class="fas fa-arrow-left me-1"></i>Изменить email
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const codeInputs = document.querySelectorAll('.code-digit');
    const hiddenInput = document.getElementById('code');
    const codeForm = document.getElementById('codeForm');
    const resendBtn = document.getElementById('resendBtn');
    const resendText = document.getElementById('resendText');
    
    const canResendInitially = "{{ can_resend }}" === "True";
    const timeLeftInitially = parseInt("{{ time_left }}") || 0;
    
    if (!canResendInitially && timeLeftInitially > 0) {
        startCountdown(timeLeftInitially);
    }
    
    codeInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            
            if (this.value) {
                if (index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                    codeInputs[index + 1].select();
                }
            }
            
            updateHiddenInput();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                if (!this.value && index > 0) {
                    codeInputs[index - 1].focus();
                    codeInputs[index - 1].value = '';
                    updateHiddenInput();
                }
            }
            
            if (e.key === 'ArrowLeft' && index > 0) {
                codeInputs[index - 1].focus();
            }
            if (e.key === 'ArrowRight' && index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text');
            const numbers = pasteData.replace(/\D/g, '');
            
            const maxFill = Math.min(numbers.length, codeInputs.length);
            for (let i = 0; i < maxFill; i++) {
                codeInputs[i].value = numbers[i];
            }
            
            if (maxFill > 0 && maxFill <= codeInputs.length) {
                codeInputs[maxFill - 1].focus();
            }
            
            updateHiddenInput();
        });
        
        input.addEventListener('focus', function() {
            this.select();
        });
    });
    
    function updateHiddenInput() {
        let code = '';
        codeInputs.forEach(input => {
            code += input.value;
        });
        hiddenInput.value = code;
        
        if (code.length === 6) {
            setTimeout(() => {
                codeForm.submit();
            }, 100);
        }
    }
    
    if (codeInputs.length > 0) {
        codeInputs[0].focus();
    }
    
    resendBtn.addEventListener('click', function() {
        if (this.disabled) return;
        
        this.disabled = true;
        this.classList.add('disabled');
        
        fetch('{% url "users:resend_reset_code" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                startCountdown(30);
                showNotification('Новый код отправлен на вашу почту!', 'success');
            } else {
                showNotification(data.message || 'Ошибка при отправке кода', 'error');
                this.disabled = false;
                this.classList.remove('disabled');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Ошибка соединения с сервером', 'error');
            this.disabled = false;
            this.classList.remove('disabled');
        });
    });
    
    function startCountdown(seconds) {
        let secondsLeft = seconds;
        
        resendBtn.disabled = true;
        resendBtn.classList.add('disabled');
        resendText.innerHTML = `Повторная отправка через <span id="countdown">${secondsLeft}</span> сек`;
        
        const countdownInterval = setInterval(() => {
            secondsLeft--;
            const countdownSpan = document.getElementById('countdown');
            if (countdownSpan) {
                countdownSpan.textContent = secondsLeft;
            }
            
            if (secondsLeft <= 0) {
                clearInterval(countdownInterval);
                resendBtn.disabled = false;
                resendBtn.classList.remove('disabled');
                resendText.innerHTML = 'Отправить код повторно';
            }
        }, 1000);
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(notification);
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}