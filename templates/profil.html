{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}
{% load math_filters %}
{% block content %}
<div class="content-card">
    <h2><i class="fas fa-user me-2"></i>{{ page_title }}</h2>
    
    <div class="row">
        <div class="col-md-4">
            <div class="text-center mb-4">
                <div class="rounded-circle mb-3 mx-auto profile-photo-container">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" 
                             alt="Фото профиля" 
                             class="profile-photo">
                    {% else %}
                        <div class="profile-photo-placeholder">
                            <i class="fas fa-user fa-4x text-muted"></i>
                        </div>
                    {% endif %}
                </div>
                <a href="{% url 'users:profile_update' %}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-1"></i>Редактировать профиль
                </a>
            </div>
            
            <div class="content-card profile-stats-card">
                <h5><i class="fas fa-info-circle me-2"></i>Информация</h5>
                <p><strong>Имя пользователя:</strong> {{ user.username }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <p><strong>Тип пользователя:</strong> {{ user.get_user_type_display }}</p>
                
                {% if user.user_type == 'student' %}
                    <p><strong>Группа:</strong> {{ user.group|default:"Не указана" }}</p>
                    <p><strong>Уровень:</strong> {{ user.level|default:"Не указан" }}</p>
                {% elif user.user_type == 'teacher' %}
                    <p><strong>Специализация:</strong> {{ user.specialization|default:"Не указана" }}</p>
                    <p><strong>Опыт работы:</strong> {{ user.experience }} лет</p>
                {% endif %}
                
                <p><strong>Дата регистрации:</strong> {{ user.date_joined|date:"d.m.Y" }}</p>
                
                {% if user.user_type == 'student' %}
                    <hr>
                    <h6><i class="fas fa-chart-line me-2"></i>Статистика курсов</h6>
                    <p><strong>Всего курсов:</strong> {{ total_courses }}</p>
                    <p><strong>В процессе:</strong> {{ in_progress_courses }}</p>
                    <p><strong>Завершено:</strong> {{ completed_courses }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-8">
            {% if user.user_type == 'student' %}
                <div class="content-card mb-4">
                    <h5><i class="fas fa-calendar me-2"></i>Моё расписание</h5>
                    
                    {% if user.group %}
                        <div class="mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" onclick="showStudentSchedule('current')">
                                    Текущая неделя
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="showStudentSchedule('next')">
                                    Следующая неделя
                                </button>
                            </div>
                        </div>
                        
                        <div id="scheduleContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка расписания...</span>
                                </div>
                                <p class="mt-2 text-muted">Загрузка расписания...</p>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Группа не указана в профиле.
                        </div>
                    {% endif %}
                </div>
            {% elif user.user_type == 'teacher' %}
                <div class="content-card mb-4">
                    <h5><i class="fas fa-calendar-alt me-2"></i>Моё расписание по группам</h5>
                    
                    <div class="mb-3">
                        <label for="groupFilter" class="form-label">Фильтр по группе:</label>
                        <select class="form-control" id="groupFilter" onchange="filterTeacherSchedule(this.value)">
                            <option value="">Все группы</option>
                            <option value="A1">Группа A1</option>
                            <option value="A2">Группа A2</option>
                            <option value="B1">Группа B1</option>
                            <option value="B2">Группа B2</option>
                            <option value="C1">Группа C1</option>
                        </select>
                    </div>
                    
                    <div id="teacherScheduleContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка расписания...</span>
                            </div>
                            <p class="mt-2 text-muted">Загрузка расписания...</p>
                        </div>
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-chalkboard-teacher me-2"></i>Мои курсы (Преподаватель)</h5>
                        <a href="{% url 'courses:teacher_courses' %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>Все курсы
                        </a>
                    </div>
                    
                    {% if user.taught_courses.all %}
                        <div class="row">
                            {% for course in user.taught_courses.all|slice:":3" %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ course.name }}</h6>
                                        <p class="card-text small text-muted mb-2">
                                            {{ course.description|truncatechars:80 }}
                                        </p>
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">
                                                Студентов: {{ course.current_students }}/{{ course.max_students }}
                                            </small>
                                            <a href="{% url 'courses:edit_course' course.id %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                Редактировать
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-3 text-center">
                            <a href="{% url 'courses:teacher_courses' %}" class="btn btn-primary">
                                <i class="fas fa-list me-1"></i>Все мои курсы ({{ user.taught_courses.count }})
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Вы пока не ведете курсы.
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            
            {% if user.user_type == 'student' %}
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-graduation-cap me-2"></i>Мои курсы</h5>
                    <a href="{% url 'courses:course_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-search me-1"></i>Найти курсы
                    </a>
                </div>
                
                {% if user_courses %}
                    <div class="row">
                        {% for order in user_courses|slice:":4" %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="card-title mb-1">{{ order.course.name }}</h6>
                                        <span class="badge 
                                            {% if order.status == 'completed' %}bg-success
                                            {% elif order.status == 'in_progress' %}bg-primary
                                            {% elif order.status == 'paid' %}bg-info
                                            {% else %}bg-warning{% endif %}">
                                            {{ order.get_status_display }}
                                        </span>
                                    </div>
                                    
                                    <p class="card-text small text-muted mb-2">
                                        <i class="fas fa-chalkboard-teacher me-1"></i>
                                        {{ order.course.teacher.get_full_name|default:order.course.teacher.username }}
                                    </p>
                                    
                                    <div class="mb-2">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar {% if order.progress == 100 %}bg-success{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ order.progress }}%;">
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ order.progress }}% завершено</small>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            {{ order.start_date|date:"d.m.Y" }}
                                        </small>
                                        <div>
                                            {% if order.status == 'in_progress' %}
                                                <a href="{% url 'courses:course_student_detail' order.id %}" 
                                                class="btn btn-sm btn-outline-primary">
                                                    Продолжить
                                                </a>
                                                <a href="{% url 'courses:cancel_course' order.id %}" 
                                                class="btn btn-sm btn-outline-warning">
                                                    Отменить
                                                </a>
                                            {% elif order.status == 'completed' %}
                                                <span class="text-success"><i class="fas fa-check-circle"></i> Завершен</span>
                                                <a href="{% url 'courses:delete_course' order.id %}" 
                                                class="btn btn-sm btn-outline-danger mt-1">
                                                    Удалить
                                                </a>
                                            {% elif order.status == 'cancelled' %}
                                                <span class="text-warning"><i class="fas fa-ban"></i> Отменен</span>
                                                <a href="{% url 'courses:delete_course' order.id %}" 
                                                class="btn btn-sm btn-outline-danger mt-1">
                                                    Удалить
                                                </a>
                                            {% else %}
                                                <a href="{% url 'courses:course_student_detail' order.id %}" 
                                                class="btn btn-sm btn-outline-secondary">
                                                    Подробнее
                                                </a>
                                                {% if order.status == 'paid' or order.status == 'pending' %}
                                                <a href="{% url 'courses:cancel_course' order.id %}" 
                                                class="btn btn-sm btn-outline-warning mt-1">
                                                    Отменить
                                                </a>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-3 text-center">
                        <a href="{% url 'courses:my_courses' %}" class="btn btn-primary">
                            <i class="fas fa-list me-1"></i>Все мои курсы ({{ user_courses.count }})
                        </a>
                        {% if user_courses.count > 0 %}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                {% with completed=user_courses|length %}
                                    Активных курсов: {{ completed }}
                                {% endwith %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Вы еще не записаны ни на один курс.
                    </div>
                    <div class="text-center">
                        <a href="{% url 'courses:course_list' %}" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Найти курсы для изучения
                        </a>
                        <p class="mt-2 text-muted small">
                            Выберите курс по вашему уровню и начните обучение!
                        </p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="schedule-data" style="display: none;">
{{ schedule_data_json|default:'{}'|safe }}
</div>

<div id="teacher-schedule" style="display: none;">
{{ teacher_schedule_json|default:'[]'|safe }}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function getScheduleData() {
    const scheduleDataElement = document.getElementById('schedule-data');
    if (scheduleDataElement) {
        try {
            const data = scheduleDataElement.textContent.trim();
            if (!data) {
                console.log('Нет данных расписания');
                return {};
            }
            const parsed = JSON.parse(data);
            console.log('Данные расписания:', parsed);
            return parsed;
        } catch (e) {
            console.error('Ошибка парсинга расписания:', e);
            console.error('Содержимое элемента:', scheduleDataElement.textContent);
            return {};
        }
    }
    return {};
}

function getTeacherScheduleData() {
    const teacherScheduleElement = document.getElementById('teacher-schedule');
    if (teacherScheduleElement) {
        try {
            const data = teacherScheduleElement.textContent.trim();
            if (!data) {
                console.log('Нет данных расписания преподавателя');
                return [];
            }
            const parsed = JSON.parse(data);
            console.log('Данные расписания преподавателя:', parsed);
            return parsed;
        } catch (e) {
            console.error('Ошибка парсинга расписания преподавателя:', e);
            console.error('Содержимое элемента:', teacherScheduleElement.textContent);
            return [];
        }
    }
    return [];
}

function showStudentSchedule(period) {
    const userType = "{{ user.user_type|default:'student' }}";
    const userGroup = "{{ user.group|default:''|escapejs }}";
    
    console.log('Пользователь:', userType, 'Группа:', userGroup);
    
    if (!userGroup) {
        document.getElementById('scheduleContent').innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Группа не указана в профиле.
            </div>
        `;
        return;
    }

    const scheduleData = getScheduleData();
    console.log('Данные расписания для группы', userGroup, ':', scheduleData);
    
    const userSchedule = [];
    Object.keys(scheduleData).forEach(day => {
        const lessonsForDay = scheduleData[day];
        lessonsForDay.forEach(lesson => {
            userSchedule.push({
                day: day,
                time: lesson.time,
                subject: lesson.subject,
                teacher: lesson.teacher,
                classroom: lesson.classroom
            });
        });
    });
    
    console.log('Расписание пользователя:', userSchedule);
    
    const scheduleContent = document.getElementById('scheduleContent');
    
    if (userSchedule.length === 0) {
        scheduleContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Расписание для вашей группы (${userGroup}) пока не составлено.
            </div>
        `;
        return;
    }

    const daysOrder = {
        'Понедельник': 1,
        'Вторник': 2,
        'Среда': 3,
        'Четверг': 4,
        'Пятница': 5,
        'Суббота': 6,
        'Воскресенье': 7
    };

    const sortedSchedule = userSchedule.sort((a, b) => {
        return daysOrder[a.day] - daysOrder[b.day];
    });
    
    const filteredSchedule = period === 'current' ? sortedSchedule : 
        sortedSchedule.map(lesson => ({
            ...lesson,
            day: lesson.day + ' (След. неделя)'
        }));
    
    if (filteredSchedule.length === 0) {
        scheduleContent.innerHTML = '<p class="text-muted">На выбранный период занятий нет.</p>';
        return;
    }

    scheduleContent.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped schedule-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-calendar-day me-2"></i>День</th>
                        <th><i class="fas fa-clock me-2"></i>Время</th>
                        <th><i class="fas fa-book me-2"></i>Предмет</th>
                        <th><i class="fas fa-chalkboard-teacher me-2"></i>Преподаватель</th>
                        <th><i class="fas fa-door-open me-2"></i>Аудитория</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredSchedule.map(lesson => `
                        <tr>
                            <td><strong>${lesson.day}</strong></td>
                            <td>${lesson.time}</td>
                            <td>
                                <span class="badge bg-primary schedule-badge">${lesson.subject}</span>
                            </td>
                            <td>${lesson.teacher || 'Не назначен'}</td>
                            <td>${lesson.classroom}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="mt-3 text-muted">
            <small><i class="fas fa-info-circle me-1"></i>Показано ${filteredSchedule.length} занятий</small>
        </div>
    `;
    
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function loadTeacherSchedule() {
    const teacherSchedule = getTeacherScheduleData();
    console.log('Расписание преподавателя:', teacherSchedule);
    
    const scheduleContent = document.getElementById('teacherScheduleContent');
    
    if (!teacherSchedule || teacherSchedule.length === 0) {
        scheduleContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Расписание не найдено.
            </div>
        `;
        return;
    }

    const daysOrder = {
        'Понедельник': 1,
        'Вторник': 2,
        'Среда': 3,
        'Четверг': 4,
        'Пятница': 5,
        'Суббота': 6,
        'Воскресенье': 7
    };

    const sortedSchedule = teacherSchedule.sort((a, b) => {
        return daysOrder[a.day] - daysOrder[b.day];
    });

    scheduleContent.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped schedule-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-calendar-day me-2"></i>День</th>
                        <th><i class="fas fa-clock me-2"></i>Время</th>
                        <th><i class="fas fa-book me-2"></i>Предмет</th>
                        <th><i class="fas fa-users me-2"></i>Группа</th>
                        <th><i class="fas fa-door-open me-2"></i>Аудитория</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedSchedule.map(lesson => `
                        <tr>
                            <td><strong>${lesson.day}</strong></td>
                            <td>${lesson.time}</td>
                            <td>
                                <span class="badge bg-primary schedule-badge">${lesson.subject}</span>
                            </td>
                            <td>
                                <span class="badge bg-success schedule-badge">${lesson.group}</span>
                            </td>
                            <td>${lesson.classroom}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="mt-3 text-muted">
            <small><i class="fas fa-info-circle me-1"></i>Показано ${sortedSchedule.length} занятий</small>
        </div>
    `;
}

function filterTeacherSchedule(group) {
    const teacherSchedule = getTeacherScheduleData();
    const filteredLessons = group ? teacherSchedule.filter(lesson => lesson.group === group) : teacherSchedule;
    
    console.log('Отфильтрованное расписание для группы', group, ':', filteredLessons);
    
    const scheduleContent = document.getElementById('teacherScheduleContent');
    
    if (!filteredLessons || filteredLessons.length === 0) {
        scheduleContent.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Занятий для выбранной группы не найдено.
            </div>
        `;
        return;
    }

    const daysOrder = {
        'Понедельник': 1,
        'Вторник': 2,
        'Среда': 3,
        'Четверг': 4,
        'Пятница': 5,
        'Суббота': 6,
        'Воскресенье': 7
    };

    const sortedSchedule = filteredLessons.sort((a, b) => {
        return daysOrder[a.day] - daysOrder[b.day];
    });

    scheduleContent.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped schedule-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-calendar-day me-2"></i>День</th>
                        <th><i class="fas fa-clock me-2"></i>Время</th>
                        <th><i class="fas fa-book me-2"></i>Предмет</th>
                        <th><i class="fas fa-users me-2"></i>Группа</th>
                        <th><i class="fas fa-door-open me-2"></i>Аудитория</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedSchedule.map(lesson => `
                        <tr>
                            <td><strong>${lesson.day}</strong></td>
                            <td>${lesson.time}</td>
                            <td>
                                <span class="badge bg-primary schedule-badge">${lesson.subject}</span>
                            </td>
                            <td>
                                <span class="badge bg-success schedule-badge">${lesson.group}</span>
                            </td>
                            <td>${lesson.classroom}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="mt-3 text-muted">
            <small><i class="fas fa-info-circle me-1"></i>Показано ${sortedSchedule.length} занятий для ${group ? 'группы ' + group : 'всех групп'}</small>
        </div>
    `;
}

function debugSchedule() {
    console.log('=== ОТЛАДКА РАСПИСАНИЯ ===');
    const studentData = getScheduleData();
    const teacherData = getTeacherScheduleData();
    console.log('Данные студента:', studentData);
    console.log('Данные преподавателя:', teacherData);
    
    const userGroup = "{{ user.group|default:''|escapejs }}";
    console.log('Группа студента:', userGroup);
    
    if (userGroup && studentData[userGroup]) {
        console.log('Найдено расписание для группы', userGroup, ':', studentData[userGroup]);
    } else {
        console.log('Расписание для группы', userGroup, 'не найдено в данных');
        console.log('Доступные группы в данных:', Object.keys(studentData));
    }
}

document.addEventListener('DOMContentLoaded', function () {
    console.log('=== ИНИЦИАЛИЗАЦИЯ ПРОФИЛЯ ===');
    
    debugSchedule();
    
    setTimeout(() => {
        const userType = "{{ user.user_type|default:'student' }}";
        console.log('Тип пользователя:', userType);
        
        if (userType === 'student') {
            showStudentSchedule('current');
        } else if (userType === 'teacher') {
            loadTeacherSchedule();
        }
    }, 100);
});
</script>
{% endblock %}